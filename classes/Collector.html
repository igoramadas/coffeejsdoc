<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CroJSDoc - Collector</title><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><div class="navbar navbar-default navbar-fixed-top"><div class="container-fluid"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li class="dropdown"><a data-toggle="dropdown" href="#" class="dropdown-toggle">Guides <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../guides/AllCommands.html">AllCommands</a></li><li><a href="../guides/SpecifyingTypes.html">SpecifyingTypes</a></li></ul></li><li><a href="../modules/collect.html">Modules</a></li><li class="active"><a href="../classes/CodeContext.html">Classes - Collector</a></li><li class="dropdown"><a data-toggle="dropdown" href="#" class="dropdown-toggle">Files <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/cli.coffee.html">cli.coffee</a></li><li><a href="../files/collect.coffee.html">collect.coffee</a></li><li><a href="../files/comment.coffee.html">comment.coffee</a></li><li><a href="../files/example.coffee.html">example.coffee</a></li><li><a href="../files/example.js.html">example.js</a></li><li><a href="../files/render.coffee.html">render.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private </label></div></div></div><div class="container-fluid content"><div class="row"><div data-spy="affix" class="hidden-xs sidebar col-sm-3"><div class="cormo-sidenav"><div class="panel panel-default"><ul class="nav nav-pills nav-stacked"><li><a href="../classes/CodeContext.html">CodeContext</a></li><li class="active"><a href="#Collector">Collector</a></li><li class="cormo-class-property private"><a href="#Collector__applyMarkdown">applyMarkdown<span class="label label-private">private</span></a></li><li class="cormo-class-property private"><a href="#Collector__classifyComments">classifyComments<span class="label label-private">private</span></a></li><li class="cormo-class-property private"><a href="#Collector__findParam">findParam<span class="label label-private">private</span></a></li><li class="cormo-class-property private"><a href="#Collector__getComments">getComments<span class="label label-private">private</span></a></li><li class="cormo-class-property private"><a href="#Collector__makeNested">makeNested<span class="label label-private">private</span></a></li><li class="cormo-class-property private"><a href="#Collector__processComments">processComments<span class="label label-private">private</span></a></li><li class="cormo-class-property private"><a href="#Collector__processParamFlags">processParamFlags<span class="label label-private">private</span></a></li><li class="cormo-class-property"><a href="#Collector__refineResult">refineResult</a></li><li class="cormo-class-property"><a href="#Collector__run">run</a></li><li><a href="../classes/Comment.html">Comment</a></li><li><a href="../classes/Renderer.html">Renderer</a></li><li><a href="../classes/Tag.html">Tag</a></li></ul></div><div class="panel panel-default"><div class="panel-heading">example</div><ul class="nav nav-pills nav-stacked"><li><a href="../classes/example.ExampleCoffee.html">ExampleCoffee</a></li><li><a href="../classes/example.ExampleJS.html">ExampleJS</a></li></ul></div></div></div><div class="col-sm-9 col-sm-offset-3"><section id="Collector"><h1 class="class_title">Collector</h1><div><p>Collector</p>
</div><div></div><button class="showcode btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/crojsdoc/blob/master//src/collect.coffee#L13">/src/collect.coffee:13</a>)</span><pre class="sourcecode prettyprint .linenums:13">class Collector
  constructor: (@paths, @options) ->
    @result =
      project_title: @options.title or 'croquis-jsdoc'
      ids: {}
      classes: {}
      guides: []
      pages: {}
      restapis: {}
      features: []
      files: []</pre></section><section id="Collector__applyMarkdown" class="private"><h2 class="class_method">Collector::applyMarkdown()<span class="label label-private">private</span></h2><div><p>Apply markdown</p>
</div><div></div><button class="showcode btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/crojsdoc/blob/master//src/collect.coffee#L153">/src/collect.coffee:153</a>)</span><pre class="sourcecode prettyprint .linenums:153">applyMarkdown: (str) ->
  # we cannot use '###' for header level 3 or above in CoffeeScript, instead web use '##\#', ''##\##', ...
  # recover this for markdown
  str = str.replace /#\\#/g, '##'
  return markdown str</pre><hr class="item-seperator"></section><section id="Collector__classifyComments" class="private"><h2 class="class_method">Collector::classifyComments()<span class="label label-private">private</span></h2><div><p>Classifies type and collect id</p>
</div><div></div><button class="showcode btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/crojsdoc/blob/master//src/collect.coffee#L162">/src/collect.coffee:162</a>)</span><pre class="sourcecode prettyprint .linenums:162">classifyComments: (file, comments) ->
  current_class = undefined
  current_module = undefined

  comments.forEach (comment) =>
    comment.defined_in = file
    comment.ctx or comment.ctx = {}
    comment.params = []
    comment.returnprops = []
    comment.throws = []
    comment.resterrors = []
    comment.sees = []
    comment.todos = []
    comment.extends = []
    comment.subclasses = []
    comment.uses = []
    comment.usedbys = []
    comment.properties = []
    comment.examples = []

    if comment.ctx.type is 'property' or comment.ctx.type is 'method'
      id = comment.ctx.string.replace('()', '')
    else
      id = comment.ctx.name
    comment.ctx.fullname = id
    comment.namespace = ''

    if comment.ctx.type is 'property' or comment.ctx.type is 'method'
      if comment.ctx.cons?
        comment.static = false
        comment.ctx.class_name = comment.ctx.cons
      else if comment.ctx.receiver?
        comment.static = true
        comment.ctx.class_name = comment.ctx.receiver

    last = 0
    for tag, i in comment.tags
      if tag.type is ''
        comment.tags[last].string += "\n#{tag.string}"
        continue
      last = i
      switch tag.type
        when 'page', 'restapi', 'class'
          comment.ctx.type = tag.type
          if tag.string
            comment.ctx.name = tag.string
            comment.ctx.fullname = id = comment.ctx.name
        when 'module'
          comment.ctx.type = 'class'
          comment.is_module = true
          if tag.string
            comment.ctx.name = tag.string
            comment.ctx.fullname = id = comment.ctx.name
          comment.code = null
        when 'memberOf'
          if /(::|#|prototype)$/.test tag.parent
            comment.static = false
            comment.ctx.class_name = tag.parent.replace /(::|#|prototype)$/, ''
          else
            comment.static = true
            comment.ctx.class_name = tag.parent
        when 'namespace'
          comment.namespace = if tag.string then tag.string + '.' else ''
        when 'property', 'method'
          comment.ctx.type = tag.type
          comment.ctx.name = tag.string
        when 'static'
          comment.static = true
        when 'private'
          comment.isPrivate = true
        when 'abstract'
          comment.abstract = true
        when 'async'
          comment.async = true
        when 'param', 'return', 'returnprop', 'throws', 'resterror', 'see'
          , 'extends', 'todo', 'type', 'api', 'uses', 'override'
        else
          console.log "Unknown tag : #{tag.type} in #{file}"

    if comment.ctx.class_name
      if comment.ctx.type is 'function'
        comment.ctx.type = 'method'
      else if comment.ctx.type is 'declaration'
        comment.ctx.type = 'property'
      seperator = if comment.static then '.' else '::'
      id = comment.ctx.class_name + seperator + comment.ctx.name
      comment.ctx.fullname = comment.ctx.class_name.replace(/.*[\./](\w+)/, '$1') + seperator + comment.ctx.name

    if comment.ctx.type is 'class'
      current_class = comment
      if comment.is_module
        current_module = comment

    if (comment.ctx.type is 'property' or comment.ctx.type is 'method') and not comment.namespace
      if current_class
        comment.namespace = current_class.namespace
      if current_module and not comment.ctx.class_name
        comment.ctx.class_name = current_module.ctx.name

    if id
      if @result.ids.hasOwnProperty id
        @result.ids[id] = 'DUPLICATED ENTRY'
      else
        @result.ids[id] = comment
        @result.ids[comment.namespace+id] = comment
      comment.html_id = (comment.namespace+id).replace(/[^A-Za-z0-9_]/g, '_')

    switch comment.ctx.type
      when 'class'
        comment.ctx.name = comment.namespace + comment.ctx.name
        comment.ctx.fullname = comment.namespace + comment.ctx.fullname
        @result.classes[comment.ctx.name] = comment
        if comment.is_module
          comment.filename = 'modules/' + comment.ctx.name.replace(/\//g, '.')
        else
          comment.filename = 'classes/' + comment.ctx.name.replace(/\//g, '.')
      when 'property', 'method'
        comment.ctx.class_name = comment.namespace + comment.ctx.class_name
        comment.filename = 'classes/' + comment.ctx.class_name.replace(/\//g, '.')
      when 'page'
        comment.filename = 'pages'
      when 'restapi'
        comment.filename = 'restapis'</pre><hr class="item-seperator"></section><section id="Collector__findParam" class="private"><h2 class="class_method">Collector::findParam(params, name)<span class="label label-private">private</span></h2><div><p>Finds a parameter in the list</p>
</div><div></div><h3>Parameters:</h3><ul><li><span>{<a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array'>Array</a>&lt;<a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a>&gt;} </span><code>params</code><span> </span></li><li><span>{<a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a>} </span><code>name</code><span> </span></li></ul><h3>Returns:</h3><ul><li><span> {<a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a>} </span><span></span><ul></ul></li></ul><button class="showcode btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/crojsdoc/blob/master//src/collect.coffee#L126">/src/collect.coffee:126</a>)</span><pre class="sourcecode prettyprint .linenums:126">findParam: (params, name) ->
  for param in params
    if param.name is name
      return param
    if param.params
      found = @findParam param.params, name
      return found if found
  return</pre><hr class="item-seperator"></section><section id="Collector__getComments" class="private"><h2 class="class_method">Collector::getComments(file)<span class="label label-private">private</span></h2><div><p>Returns list of comments of the given file</p>
</div><div></div><h3>Parameters:</h3><ul><li><span>{<a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a>} </span><code>file</code><span> </span></li></ul><h3>Returns:</h3><ul><li><span> {<a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array'>Array</a>&lt;<a href='../classes/Comment.html#Comment'>Comment</a>&gt;} </span><span></span><ul></ul></li></ul><button class="showcode btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/crojsdoc/blob/master//src/collect.coffee#L30">/src/collect.coffee:30</a>)</span><pre class="sourcecode prettyprint .linenums:30">getComments: (file, path) ->
  return if fs.statSync(file).isDirectory()
  content = fs.readFileSync(file, 'utf-8').trim()
  return if not content

  file = file.substr(path.length+1)

  if /\.coffee$/.test file
    comments = dox.parseCommentsCoffee content, { raw: true }
    add_to_file = true
  else if /\.js$/.test file
    comments = dox.parseComments content, { raw: true }
    add_to_file = true
  else if /Page\.md$/.test file
    namespace = ''
    file = file.substr(0, file.length-3).replace(/[^A-Za-z0-9]*Page$/, '')
    file = file.replace /(.*)\//, (_, $1) ->
      namespace = $1
      return ''
    comments = [ {
      description:
        summary: ''
        body: content
        full: ''
      tags: [
        { type: 'page', string: file }
        { type: 'namespace', string: namespace }
      ]
    } ]
  else if /Guide\.md$/.test file
    file = file.substr(0, file.length-8).replace(/\//g, '.')
    @result.guides.push
      name: file
      filename: 'guides/' + file
      content: content
  else if /\.feature$/.test file
    file = file.substr 0, file.length-8
    namespace = ''
    file = file.replace /(.*)\//, (_, $1) ->
      namespace = $1 + '/'
      return ''
    feature = ''
    content = content.replace /Feature: (.*)/, (_, $1) ->
      feature = $1
      return ''
    @result.features.push
      name: namespace + file
      namespace: namespace
      filename: 'features/' + namespace.replace(/\//g, '.') + file
      feature: feature
      content: content

  if add_to_file
    namespace = ''
    file = file.replace /(.*)\//, (_, $1) ->
      namespace = $1 + '/'
      return ''
    @result.files.push
      name: namespace + file
      namespace: namespace
      filename: 'files/' + namespace.replace(/\//g, '.') + file
      content: content

  # filter out empty comments
  return comments?.filter (comment) ->
    return comment.description.full or comment.description.summary or comment.description.body or comment.tags?.length > 0</pre><hr class="item-seperator"></section><section id="Collector__makeNested" class="private"><h2 class="class_method">Collector::makeNested()<span class="label label-private">private</span></h2><div><p>Makes parameters(or returnprops) nested</p>
</div><div></div><button class="showcode btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/crojsdoc/blob/master//src/collect.coffee#L138">/src/collect.coffee:138</a>)</span><pre class="sourcecode prettyprint .linenums:138">makeNested: (comment, targetName) ->
  i = comment[targetName].length
  while i-->0
    param = comment[targetName][i]
    if match = param.name.match /\[?([^=]*)\.([^\]]*)\]?/
      parentParam = @findParam comment[targetName], match[1]
      if parentParam
        comment[targetName].splice i, 1
        parentParam[targetName] = parentParam[targetName] or []
        param.name = match[2]
        parentParam[targetName].unshift param</pre><hr class="item-seperator"></section><section id="Collector__processComments" class="private"><h2 class="class_method">Collector::processComments()<span class="label label-private">private</span></h2><div><p>Structuralizes comments</p>
</div><div></div><button class="showcode btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/crojsdoc/blob/master//src/collect.coffee#L289">/src/collect.coffee:289</a>)</span><pre class="sourcecode prettyprint .linenums:289">processComments: (comments) ->
  comments.forEach (comment) =>
    desc = comment.description
    if desc
      desc.full = @applyMarkdown desc.full
      desc.summary = @applyMarkdown desc.summary
      desc.body = @applyMarkdown desc.body

    for tag in comment.tags
      switch tag.type
        when 'param'
          tag = @processParamFlags tag
          for type, i in tag.types
            tag.types[i] = type
          tag.description = tag.description
          comment.params.push tag
        when 'return'
          for type, i in tag.types
            tag.types[i] = type
          tag.description = tag.description
          comment.return = tag
        when 'returnprop'
          tag = dox.parseTag '@param ' + tag.string
          tag = @processParamFlags tag
          for type, i in tag.types
            tag.types[i] = type
          tag.description = tag.description
          comment.returnprops.push tag
        when 'throws'
          if /{([^}]+)}\s*(.*)/.exec tag.string
            comment.throws.push message: RegExp.$1, description: RegExp.$2
          else
            comment.throws.push message: tag.string, description: ''
        when 'resterror'
          if /{(\d+)\/([A-Za-z0-9_ ]+)}\s*(.*)/.exec tag.string
            comment.resterrors.push code: RegExp.$1, message: RegExp.$2, description: RegExp.$3
        when 'see'
          str = tag.local or tag.url
          comment.sees.push str
        when 'todo'
          comment.todos.push tag.string
        when 'extends'
          comment.extends.push tag.string
          @result.ids[tag.string]?.subclasses.push comment.ctx.name
        when 'uses'
          comment.uses.push tag.string
          @result.ids[tag.string]?.usedbys.push comment.ctx.name
        when 'type'
          for type, i in tag.types
            tag.types[i] = type
          comment.types = tag.types
        when 'example'
          comment.examples.push tag
        when 'override'
          if @result.ids[tag.string] and @result.ids[tag.string] isnt 'DUPLICATED ENTRY'
            comment.override = @result.ids[tag.string]
          comment.override_link = tag.string

    if comment.ctx.type is 'class'
      if /^class +\w+ +extends +([\w\.]+)/.exec comment.code
        comment.extends.push RegExp.$1
        @result.ids[RegExp.$1]?.subclasses.push comment.ctx.name

    # make parameters nested
    @makeNested comment, 'params'
    @makeNested comment, 'returnprops'

    switch comment.ctx.type
      when 'property', 'method'
        class_name = comment.ctx.class_name
        if class_name and class_comment = @result.classes[class_name]
          class_comment.properties.push comment
          if class_comment.is_module
            comment.filename = comment.filename.replace('classes/', 'modules/')
      when 'page'
        @result.pages[comment.ctx.name] = comment
      when 'restapi'
        @result.restapis[comment.ctx.name] = comment</pre><hr class="item-seperator"></section><section id="Collector__processParamFlags" class="private"><h2 class="class_method">Collector::processParamFlags(tag)<span class="label label-private">private</span></h2><div><p>Checks flags of parameter</p>
</div><div><ul>
<li>&#39;[&#39; name &#39;]&#39; : optional</li>
<li>name &#39;=&#39; value : default value</li>
<li>&#39;+&#39; name : addable</li>
<li>&#39;-&#39; name : excludable</li>
</ul>
</div><h3>Parameters:</h3><ul><li><span>{<a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a>} </span><code>tag</code><span> </span></li></ul><h3>Returns:</h3><ul><li><span> {<a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a>} </span><span>given tag</span><ul></ul></li></ul><button class="showcode btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/crojsdoc/blob/master//src/collect.coffee#L107">/src/collect.coffee:107</a>)</span><pre class="sourcecode prettyprint .linenums:107">processParamFlags: (tag) ->
  # is optional parameter?
  if /\[([^\[\]]+)\]/.exec tag.name
    tag.name = RegExp.$1
    tag.optional = true
  if tag.name.substr(0, 1) is '+'
    tag.name = tag.name.substr(1)
    tag.addable = true
  if tag.name.substr(0, 1) is '-'
    tag.name = tag.name.substr(1)
    tag.excludable = true
  return tag</pre><hr class="item-seperator"></section><section id="Collector__refineResult"><h2 class="class_method">Collector::refineResult()</h2><div><p>Refines result.</p>
</div><div><ul>
<li>convert hash to sorted array</li>
<li>classes -&gt; classes &amp; modules</li>
</ul>
</div><button class="showcode btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/crojsdoc/blob/master//src/collect.coffee#L373">/src/collect.coffee:373</a>)</span><pre class="sourcecode prettyprint .linenums:373">refineResult: ->
  result = @result
  result.classes = Object.keys(result.classes).sort( (a,b) ->
    a_ns = result.classes[a].namespace
    b_ns = result.classes[b].namespace
    return -1 if a_ns < b_ns
    return 1 if a_ns > b_ns
    if a<b then -1 else 1
  ).map (name) -> result.classes[name]
  result.pages = Object.keys(result.pages).sort( (a,b) ->
    a_ns = result.pages[a].namespace
    b_ns = result.pages[b].namespace
    return -1 if a_ns < b_ns
    return 1 if a_ns > b_ns
    if a<b then -1 else 1
  ).map (name) -> result.pages[name]
  result.restapis = Object.keys(result.restapis).sort( (a,b) ->
    a_ns = result.restapis[a].namespace
    b_ns = result.restapis[b].namespace
    return -1 if a_ns < b_ns
    return 1 if a_ns > b_ns
    a = a.replace /([A-Z]+) \/(.*)/, '-$2 $1'
    b = b.replace /([A-Z]+) \/(.*)/, '-$2 $1'
    if a<b then -1 else 1
  ).map (name) -> result.restapis[name]
  result.guides = result.guides.sort (a,b) ->
    if a.name<b.name then -1 else 1
  result.features = result.features.sort (a,b) ->
    if a.name<b.name then -1 else 1
  result.files = result.files.sort (a,b) ->
    a_ns = a.namespace
    b_ns = b.namespace
    return -1 if a_ns < b_ns
    return 1 if a_ns > b_ns
    if a.name<b.name then -1 else 1

  result.modules = result.classes.filter (klass) -> klass.is_module
  result.classes = result.classes.filter (klass) -> not klass.is_module</pre><hr class="item-seperator"></section><section id="Collector__run"><h2 class="class_method">Collector::run()</h2><div><p>Runs</p>
</div><div></div><button class="showcode btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/crojsdoc/blob/master//src/collect.coffee#L414">/src/collect.coffee:414</a>)</span><pre class="sourcecode prettyprint .linenums:414">run: ->
  file_count_read = 0

  all_comments = []
  @paths.forEach (path) =>
    base_path = path = resolve @options.project_dir, path
    base_path = dirname base_path while /[*?]/.test basename(base_path)
    glob.sync(path).forEach (path) =>
      if fs.statSync(path).isDirectory()
        list = walkdir.sync path
      else
        list = [path]
      list.forEach (file) =>
        comments = @getComments file, base_path
        return if not comments?

        file_count_read++
        console.log file + ' is processed' if not @options.quite

        file = file.replace new RegExp("^" + @options.project_dir), ''
        @classifyComments file, comments
        all_comments.push.apply all_comments, comments

  console.log 'Total ' + file_count_read + ' files processed'

  @processComments all_comments

  if not @options.files
    @result.files = []
  @refineResult()</pre><hr class="item-seperator"></section></div></div></div><script src="http://code.jquery.com/jquery-1.11.0.min.js"></script><script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><a href="https://github.com/croquiscom/crojsdoc"><img src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub" class="github-ribbon"></a></body></html>